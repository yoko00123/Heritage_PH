"use strict";define(["app"],function(n){n.provider("DataService",function(){var n=this;return n.Controller="Action",n.AppName="Web",n.Encryption={Token:null,Salt:null},n.ResultAdapter=function(t,i){var u={},r=t,f,e;if(typeof r=="string"&&(r=JSON.parse(r)),f=(n.Encryption.Token+i).substr(0,32),e=(n.Encryption.Salt.substr(0,f.length/4)+n.Encryption.Guid+i).substr(0,f.length/2),r.Status===1)throw new Error(r.ErrorMsg);return typeof r.ResultSet=="number"||typeof r.ResultSet=="object"?u.ResultSet=r.ResultSet:r.ResultSet&&(u.ResultSet=JSON.parse(NickCrypt.Decrypt(r.ResultSet,f,e))),u.Status=r.Status,u.ErrorMsg=r.ErrorMsg,u.data=t,u},n.EncryptData=function(t,i){var r=(new Date).getTime()/1e3|0,u=(n.Encryption.Token+r+t).substr(0,32),e=n.Encryption.Salt.substr(0,u.length/4)+n.Encryption.Guid+r,f=JSON.stringify(i||{});return f=NickCrypt.Encrypt(f,u,e.substr(0,u.length/2)),{Date:r,Data:f}},{SetDefaultController:function(t){n.Controller=t},SetAppName:function(t){n.AppName=t},$get:["$http","$q",function(t){return{SetController:function(t){n.Controller=t},GetController:function(){return n.Controller},SetEncryption:function(t){n.Encryption=JSON.parse(t)},Post:function(i,r,u,f){var e=$.Deferred(),s=window.VirtualPath||"",o=n.EncryptData(i,r),h={url:s+"/api/"+(u||n.Controller)+"/"+i,method:"POST",data:o.Data,dataType:"json",disableInterceptor:f==undefined?!1:f,headers:{"Request-Date":o.Date}};return t(h).then(function(t){try{var i=n.ResultAdapter(t.data,t.headers("Request-Date"));e.resolve(i.ResultSet,i.Status)}catch(r){e.reject(r)}})["catch"](e.reject),e.promise()},ByteLength:function(n){for(var t,r=n.length,i=n.length-1;i>=0;i--)t=n.charCodeAt(i),t>127&&t<=2047?r++:t>2047&&t<=65535&&(r+=2),t>=56320&&t<=57343&&i--;return r},UrlApi:function(t){var i=window.VirtualPath||"";return i+"/api/"+n.Controller+"/"+t},Upload:function(i,r){var u=$.Deferred(),f=window.VirtualPath||"",e=n.EncryptData(name,null);return t.post(f+"/api/"+n.Controller+"/"+i,r,{headers:{"Content-Type":undefined,"Request-Date":e.Date},transformRequest:function(n){return n}}).then(function(t){try{var i=n.ResultAdapter(t.data,t.headers("Request-Date"));u.resolve(i.ResultSet,i.Status)}catch(r){u.reject(r)}})["catch"](u.reject),u.promise()},Download:function(n,t,i){var r=this;return this.Post(n,t,i).then(function(n){return r.DownloadSlim(n)})},DownloadSlim:function(n,i){var u=window.VirtualPath||"",r="";return i&&(r="&c="+LZString.compressToEncodedURIComponent(i)),t.get(u+"/api/Action/DownloadFile?f="+n+r,{responseType:"arraybuffer",headers:{"Request-Date":(new Date).getTime()/1e3|0}}).then(function(n){var s,f,r,h,t,e;try{var c="application/octet-stream",i=!1,o=n.headers("x-filename")||"download.bin",l=n.headers("content-type")||c;try{if(console.log("Trying saveBlob method ..."),t=new Blob([n.data],{type:l}),navigator.msSaveBlob)navigator.msSaveBlob(t,o);else{if(s=navigator.webkitSaveBlob||navigator.mozSaveBlob||navigator.saveBlob,s===undefined)throw"Not supported";s(t,o)}console.log("saveBlob succeeded");i=!0}catch(u){console.log("saveBlob method failed with the following exception:");console.log(u)}if(!i&&(f=window.URL||window.webkitURL||window.mozURL||window.msURL,f)){if(r=document.createElement("a"),"download"in r)try{console.log("Trying download link method with simulated click ...");t=new Blob([n.data],{type:l});e=f.createObjectURL(t);r.setAttribute("href",e);r.setAttribute("download",o);h=document.createEvent("MouseEvents");h.initMouseEvent("click",!0,!0,window,1,0,0,0,0,!1,!1,!1,!1,0,null);r.dispatchEvent(h);console.log("Download link method with simulated click succeeded");i=!0}catch(u){console.log("Download link method with simulated click failed with the following exception:");console.log(u)}if(!i)try{console.log("Trying download link method with window.location ...");t=new Blob([n.data],{type:c});e=f.createObjectURL(t);window.location=e;console.log("Download link method with window.location succeeded");i=!0}catch(u){console.log("Download link method with window.location failed with the following exception:");console.log(u)}}i||(console.log("No methods worked for saving the arraybuffer, using last resort window.open"),window.open(httpPath,"_blank",""))}catch(u){console.error(u)}})["catch"](function(n,t){console.log("Request failed with status: "+t)})},GetMenu:function(n){return this.Post("GetMenu",{ID_Menu:n})},GetWebWidget:function(n){return this.Post("GetWidget",{ID_Menu:n})},AppName:n.AppName}}]}});n.factory("Session",function(){var n=this;return n.DataBank={},n.SessionData={},{UserRow:function(t){if(t)n.SessionData=t,n.SessionData.ID_Session=n.SessionData.ID,delete n.SessionData.ID;else return n.SessionData},Session:function(t){return n.SessionData[t]},Clear:function(){n.SessionData={}},DataBank:function(t,i){if(i)n.DataBank[t]=i;else return n.DataBank[t]}}});n.factory("$Invoker",function(){return{events:{},group:function(n){var t=this;return t.events[n]==null&&(t.events[n]=[]),{on:function(i,r){t.on(n,i,r)},invoke:function(i){try{var r=[],u=Array.prototype.slice.call(arguments,1);return t.events[n].forEach(function(n){i===n.Name&&r.push(n.Action.apply(this,u))}),$.when.apply(undefined,r).promise().then(function(){return Array.prototype.slice.call(arguments,0)}).fail(function(n){console.error(n)})}catch(f){console.error(i,f);throw new Error("Method "+i+" not found");}},all:function(n){var i;try{var r=[],f=Array.prototype.slice.call(arguments,1),u=Object.keys(t.events);for(i=0;i<u.length;i++)t.events[u[i]].forEach(function(t){n===t.Name&&r.push(t.Action.apply(this,f))});return $.when.apply(undefined,r).promise().then(function(){return Array.prototype.slice.call(arguments,0)}).fail(function(n){console.error(n)})}catch(e){console.error(n,e);throw new Error("Method "+n+" not found");}},clear:function(){t.clear(n)}}},on:function(n,t,i){var r=this;this.events[n].push({Name:t,Action:i})},invoke:function(n,t){try{var i=[],r=Array.prototype.slice.call(arguments,2);return this.events[n].forEach(function(n){t===n.Name&&i.push(n.Action.apply(this,r))}),$.when.apply(undefined,i).promise().then(function(){return Array.prototype.slice.call(arguments,0)}).fail(function(n){console.error(n)})}catch(u){console.error(t,u);throw new Error("Method "+t+" not found");}},clear:function(n){delete this.events[n]}}});n.filter("nospace",function(){return function(n){return n?n.replace(/ /g,""):""}});n.filter("humanizeDoc",function(){return function(n){if(n)return n.type==="directive"?n.name.replace(/([A-Z])/g,function(n){return"-"+n.toLowerCase()}):n.label||n.name}})});